/*! jQuery Preview - v3.0.0 - 2013-01-23
* https://github.com/embedly/jquery-preview
* Copyright (c) 2013 Sean Creeley; Licensed BSD */
(function(e){var t=function(){function e(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}function n(e,t){for(var n=[];t>0;n[--t]=e);return n.join("")}var r=function(){return r.cache.hasOwnProperty(arguments[0])||(r.cache[arguments[0]]=r.parse(arguments[0])),r.format.call(null,r.cache[arguments[0]],arguments)};return r.format=function(r,i){var s=1,o=r.length,u="",a,f=[],l,c,h,p,d,v;for(l=0;l<o;l++){u=e(r[l]);if(u==="string")f.push(r[l]);else if(u==="array"){h=r[l];if(h[2]){a=i[s];for(c=0;c<h[2].length;c++){if(!a.hasOwnProperty(h[2][c]))throw t('[sprintf] property "%s" does not exist',h[2][c]);a=a[h[2][c]]}}else h[1]?a=i[h[1]]:a=i[s++];if(/[^s]/.test(h[8])&&e(a)!="number")throw t("[sprintf] expecting number but found %s",e(a));switch(h[8]){case"b":a=a.toString(2);break;case"c":a=String.fromCharCode(a);break;case"d":a=parseInt(a,10);break;case"e":a=h[7]?a.toExponential(h[7]):a.toExponential();break;case"f":a=h[7]?parseFloat(a).toFixed(h[7]):parseFloat(a);break;case"o":a=a.toString(8);break;case"s":a=(a=String(a))&&h[7]?a.substring(0,h[7]):a;break;case"u":a=Math.abs(a);break;case"x":a=a.toString(16);break;case"X":a=a.toString(16).toUpperCase()}a=/[def]/.test(h[8])&&h[3]&&a>=0?"+"+a:a,d=h[4]?h[4]=="0"?"0":h[4].charAt(1):" ",v=h[6]-String(a).length,p=h[6]?n(d,v):"",f.push(h[5]?a+p:p+a)}}return f.join("")},r.cache={},r.parse=function(e){var t=e,n=[],r=[],i=0;while(t){if((n=/^[^\x25]+/.exec(t))!==null)r.push(n[0]);else if((n=/^\x25{2}/.exec(t))!==null)r.push("%");else{if((n=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(t))===null)throw"[sprintf] huh?";if(n[2]){i|=1;var s=[],o=n[2],u=[];if((u=/^([a-z_][a-z_\d]*)/i.exec(o))===null)throw"[sprintf] huh?";s.push(u[1]);while((o=o.substring(u[0].length))!=="")if((u=/^\.([a-z_][a-z_\d]*)/i.exec(o))!==null)s.push(u[1]);else{if((u=/^\[(\d+)\]/.exec(o))===null)throw"[sprintf] huh?";s.push(u[1])}n[2]=s}else i|=2;if(i===3)throw"[sprintf] mixing positional and named placeholders is not (yet) supported";r.push(n)}t=t.substring(n[0].length)}return r},r}(),n=function(e,n){return n.unshift(e),t.apply(null,n)};(function(e){function r(e){return e===null||e===undefined}function i(t,n){var r=[],s=[];return e.each(t,function(e,t){s.push(t),i.length===n&&(r.push(s),s=[])}),s.length!==0&&r.push(s),r}function s(t){return r(t)?[]:e.isArray(t)?t:[t]}function o(e){return e[0].map(function(t,n){return e.map(function(e){return e[n]})})}var t={key:null,endpoint:"oembed",secure:null,query:{},method:"replace",addImageStyles:!0,wrapElement:"div",className:"embed",batch:20},n=/(http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/,u=function(e,t,n){this.init(e,t,n)};u.prototype={init:function(t){this.urls=t,this.count=0,this.results={},this._deferred=e.Deferred()},notify:function(e){this.results[e.original_url]=e,this.count++,this._deferred.notify.apply(this._deferred,[e]);if(this.count===this.urls.length){var t=this,n=this.urls.map(function(e){return t.results[e]});this._deferred.resolve(n)}return this},state:function(){return this._deferred.state.apply(this._deferred,arguments)}},window.Keeper=u;var a=function(){};a.prototype={defaults:{},log:function(e,t){!r(window.console)&&!r(window.console[e])&&window.console[e].apply(window.console,[t])},build:function(t,n,i){i=r(i)?{}:i;var s=i.secure;r(s)&&(s=window.location.protocol==="https:"?!0:!1);var o=(s?"https":"http")+"://api.embed.ly/"+(t==="objectify"?"2/":"1/")+t,u=r(i.query)?{}:i.query;return u.key=i.key,o+="?"+e.param(u),o+="&urls="+n.map(encodeURIComponent).join(","),o},ajax:function(a,f,l){l=e.extend({},t,e.embedly.defaults,typeof l=="object"&&l);if(r(l.key))return this.log("error","Embedly jQuery requires an API Key. Please sign up for one at http://embed.ly"),null;f=s(f);var c=new u(f),h=[],p=[];e.each(f,function(e,t){n.test(t)?h.push(t):p.push({url:t,original_url:t,error:!0,invalid:!0,error_message:'Invalid url "'+t+'"'})});var d=i(h,l.batch),v=this;return e.each(d,function(t,n){e.ajax({url:v.build(a,n,l),dataType:"jsonp",success:function(t){e.each(o([n,t]),function(e,t){var n=t[1];n.original_url=t[0],n.invalid=!1,c.notify(n)})}})}),p.length&&setTimeout(function(){e.each(p,function(e,t){c.notify(t)})},1),c._deferred},oembed:function(e,t){return this.ajax("oembed",e,t)},preview:function(e,t){return this.ajax("preview",e,t)},objectify:function(e,t){return this.ajax("objectify",e,t)}};var f=function(e,t,n){this.init(e,t,n)};f.prototype={init:function(t,n,r){this.elem=t,this.$elem=e(t),this.original_url=n,this.options=r,this.loaded=e.Deferred();var i=this;this.loaded.done(function(){i.$elem.trigger("loaded",[i])}),this.$elem.trigger("initialized",[this])},progress:function(t){e.extend(this,t),this.options.display?this.options.display.apply(this.elem,[this,this.elem]):this.options.endpoint==="oembed"&&this.display(),this.loaded.resolve(this)},imageStyle:function(){var e=[],t;return this.options.addImageStyles&&(this.options.query.maxwidth&&(t=isNaN(parseInt(this.options.query.maxwidth,10))?"":"px",e.push("max-width: "+this.options.query.maxwidth+t)),this.options.query.maxheight&&(t=isNaN(parseInt(this.options.query.maxheight,10))?"":"px",e.push("max-height: "+this.options.query.maxheight+t))),e.join(";")},display:function(){this.style=this.imageStyle();var e;this.type==="photo"?(e="<a href='"+this.original_url+"' target='_blank'>",e+="<img style='"+this.style+"' src='"+this.url+"' alt='"+this.title+"' /></a>"):this.type==="video"||this.type==="rich"?e=this.html:(this.title=this.title||this.url,e=this.thumbnail_url?"<img src='"+this.thumbnail_url+"' class='thumb' style='"+this.style+"'/>":"",e+="<a href='"+this.original_url+"'>"+this.title+"</a>",e+=this.provider_name?"<a href='"+this.provider_url+"' class='provider'>"+this.provider_name+"</a>":"",e+=this.description?'<div class="description">'+this.description+"</div>":""),this.options.wrapElement&&(e="<"+this.options.wrapElement+' class="'+this.options.className+'">'+e+"</"+this.options.wrapElement+">"),this.code=e,this.options.method==="replace"?this.$elem.replaceWith(this.code):this.options.method==="after"?this.$elem.after(this.code):this.options.method==="afterParent"?this.$elem.parent().after(this.code):this.options.method==="replaceParent"&&this.$elem.parent().replaceWith(this.code),this.$elem.trigger("displayed",[this])}},e.embedly=new a,e.fn.embedly=function(n){if(n===undefined||typeof n=="object"){n=e.extend({},t,e.embedly.defaults,typeof n=="object"&&n);if(r(n.key))return e.embedly.log("error","Embedly jQuery requires an API Key. Please sign up for one at http://embed.ly"),this.each(e.noop);var i={},s=function(t){if(!e.data(e(t),"embedly")){var r=e(t).attr("href"),s=new f(t,r,n);e.data(t,"embedly",s),i.hasOwnProperty(r)?i[r].push(s):i[r]=[s]}},o=this.each(function(){r(e(this).attr("href"))?e(this).find("a").each(function(){r(e(this).attr("href"))||s(this)}):s(this)}),u=e.embedly.ajax(n.endpoint,e.map(i,function(e,t){return t}),n).progress(function(t){e.each(i[t.original_url],function(e,n){n.progress(t)})});return n.progress&&u.progress(n.progress),n.done&&u.done(n.done),o}},e.expr[":"].embedly=function(t){return!r(e(t).data("embedly"))}})(jQuery),function(e){var n=function(e,t){this.init(e,t)};n.prototype={init:function(t,n){this.$elem=e(t),this.options=e.extend({},{onchange:e.noop},n),this.$elem.find(".left").on("click",e.proxy(this.scroll,this)),this.$elem.find(".right").on("click",e.proxy(this.scroll,this)),this.$elem.find(".nothumb").on("click",e.proxy(this.nothumb,this)),this.$elem.one("mouseenter",function(){e(this).on("mouseenter mouseleave",function(){e(this).find(".controls").toggle()})})},scroll:function(t){t.preventDefault();var n=this.$elem.find(".images"),r=parseInt(n.find("li").css("width"),10),i=parseInt(n.css("left"),10),s=n.find("img").length*r;if(e(t.target).hasClass("left")){i=parseInt(i,10)+r;if(i>0)return!1}else{i=parseInt(i,10)-r;if(i<=-s)return!1}var o=n.find("img").eq(i/-r);this.options.onchange.call(o,o),n.css("left",i+"px")},nothumb:function(e){e.preventDefault(),this.$elem.hide(),this.options.onchange.call(null,null)}},e.fn.thumb=function(t){return e(this).each(function(){e(this).data("thumb",new n(this,t))})};var r=function(){};r.prototype={protocolExp:/^http(s?):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/i,urlExp:/[-\w]+(\.[a-z]{2,})+(\S+)?(\/|\/[\w#!:.?+=&%@!\-\/])?/gi,url:function(t){t=e.trim(t);if(t==="")return null;var n=t.match(this.protocolExp),r=n?n[0]:null;return r===null&&(n=t.match(this.urlExp),r=n?"http://"+n[0]:null),r=e.trim(r),r===""?null:r},none:function(e){return e===null||e===undefined}};var i=new r,s=function(){};s.prototype={template:['<div class="selector">',"%(image_html)s",'<div class="attributes">',"{{>attributes}}",'<span class="meta">',"{{>favicon}}",'<a class="provider" href="{{provider_url}}">{{provider_display}}</a>',"</span>","</div>",'<div class="action"><a href="#" class="close">&#10005;</a></div>',"</div>"].join(""),render:function(n,r,s,o){this.preview=s;var u=e.extend(!0,{},r);u.title=u.title?u.title:u.url;var a=u.favicon_url?'<img class="favicon" src="%(favicon_url)s">':"",f=u.images.map(function(e){return t('<li><img src="%(url)s"/></li>',e)}).join("");f!==""&&(f=['<div class="thumb">','<div class="controls">','<a class="left" href="#">&#9664;</a>','<a class="right" href="#">&#9654;</a>','<a class="nothumb" href="#">&#10005;</a>',"</div>",'<div class="items">','<ul class="images">',f,"</ul>","</div>","</div>"].join(""));var l=['<div class="selector">',f,'<div class="attributes">','<a class="title" href="#" contenteditable=true>%(title)s</a>','<p><a class="description" href="#" contenteditable=true>%(description)s</a></p>','<span class="meta">',a,'<a class="provider" href="%(provider_url)s">%(provider_display)s</a>',"</span>","</div>",'<div class="action"><a href="#" class="close">&#10005;</a></div>',"</div>"].join(""),c=t(l,u),h=n.closest("form").find(o.selector).eq(0);h.length===0&&(h=e(".selector-wrapper").eq(0));if(h.length!==1)return!1;h.html(e(c)),h.find(".thumb").thumb({onchange:e.proxy(function(t){i.none(t)?this.preview.update("thumbnail_url",null):this.preview.update("thumbnail_url",e(t).attr("src"))},this)}),h.find(".title").on("blur",e.proxy(function(t){this.preview.update("title",e(t.target).text())},this)),h.find(".description").on("blur",e.proxy(function(t){this.preview.update("description",e(t.target).text())},this)),h.find(".action .close").bind("click",e.proxy(function(e){this.preview.clear(),h.find(".selector").remove()},this)),h.find(".selector").bind("mouseenter mouseleave",function(){e(this).find(".action").toggle()}),n.on("close",e.proxy(function(){this.preview.clear(),h.find(".selector").remove()},this))}};var o={debug:!0,selector:{selector:".selector-wrapper"},preview:{},field:null,query:{wmode:"opaque",words:30,maxwidth:560}},u=function(e,t){this.init(e,t)};u.prototype={$form:null,data:{},init:function(t,n){this.elem=t,this.$elem=e(t);var r=this.$elem.parents("form").eq(0);r.length===1&&(this.$form=r),this.options=e.extend({},o,n),this.$elem.on("keyup",e.proxy(this.keyUp,this)),this.$elem.on("paste",e.proxy(this.paste,this)),this.$elem.on("blur",e.proxy(this.paste,this)),this.$elem.data("preview",{})},log:function(){this.options.debug&&window.console&&window.console.log(Array.prototype.slice.call(arguments))},update:function(e,t){var n=this.$elem.data("preview");n[e]=t},clear:function(){this.$elem.data("preview",{})},keyUp:function(e){if(e.which!==32&&e.which!==13)return null;var t=i.url(this.$elem.val());if(t===null)return null;this.log("onKeyUp url:"+t),this.$elem.off("keyup"),this.fetch(t)},paste:function(t){setTimeout(e.proxy(function(){this.fetch()},this),200)},fetch:function(t){t===undefined&&(t=i.url(this.$elem.val())),this.log(t);if(t===null||this.data.original_url===t)return!1;e.embedly.preview(t,{key:this.options.key,query:this.options.query}).progress(e.proxy(this._callback,this))},error:function(e){},_callback:function(e){this.log(e);if(!e.hasOwnProperty("type"))return this.log("Embedly returned an invalid response"),this.error(e),!1;if(e.type==="error")return this.log("URL ("+e.url+") returned an error: "+e.error_message),this.error(e),!1;if(!e.safe)return this.log("URL ("+e.url+") was deemed unsafe: "+e.safe_message),this.error(e),!1;if(!(e.type in{html:"",image:""}))return this.log("URL ("+e.url+") returned a type ("+e.type+") not handled"),this.error(e),!1;e.images.length>0&&(e.thumbnail_url=e.images[0].url),this.$elem.data("preview",e);var t=new s;t.render(this.$elem,e,this,this.options.selector),this.log("done",e)}},e.fn.preview=function(t,n){return e(this).each(function(e,n){new u(this,t)})}}(jQuery,window,document)})(jQuery,window,document);